version: '3.8'

services:
  plextracapi:
    environment:
      STARTUP_MODE: API_ONLY
    env_file:
      - .env
    image: "plextrac/plextracapi:${UPGRADE_STRATEGY:-stable}"
    restart: always
    volumes:
    - uploads:/usr/src/plextrac-api/uploads:rw
    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl http://localhost:4350/api/v2/health/live"

  couchbase-migrations:
    profiles:
      - "database-migrations"
    depends_on:
      - plextracdb
      - redis
    image: "plextrac/plextracapi:${UPGRADE_STRATEGY:-stable}"
    entrypoint: ''
    command: |
      sh -c
        "npm run maintenance:enable &&
         npm run db:migrate &&
         npm run maintenance:disable"
    environment:
      CB_API_PASS: ${CB_API_PASS}
      CB_API_USER: ${CB_API_USER}
      REDIS_CONNECTION_STRING: ${REDIS_CONNECTION_STRING:-redis}
      REDIS_PASSWORD: ${REDIS_PASSWORD:?err}

  plextracdb:
    environment:
      ADMIN_EMAIL: "${ADMIN_EMAIL:-}"
      CB_ADMIN_USER: "${CB_ADMIN_USER:?err}"
      CB_ADMIN_PASS: "${CB_ADMIN_PASS:?err}"
      CB_API_USER: "${CB_API_USER:?err}"
      CB_API_PASS: "${CB_API_PASS:?err}"
      CB_BACKUP_USER: "${CB_BACKUP_USER:?err}"
      CB_BACKUP_PASS: "${CB_BACKUP_PASS:?err}"
      CB_BUCKET: "${CB_BUCKET-}"
      BACKUP_DIR: "${BACKUP_DIR-}"
      bucket: "${bucket-}"
    image: plextrac/plextracdb:6.5.1
    ports:
    - 127.0.0.1:8091:8091/tcp
    - 127.0.0.1:8092:8092/tcp
    - 127.0.0.1:8093:8093/tcp
    - 127.0.0.1:8094:8094/tcp
    restart: always
    volumes:
    - dbdata:/opt/couchbase/var:rw
    - couchbase-backups:/backups:rw
    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl --head --fail -X GET -u $CB_ADMIN_USER:$CB_ADMIN_PASS -H 'Content-Type: application/json' http://localhost:8091/pools/default/buckets/reportMe || exit 1"
      interval: 10s
      retries: 6
      start_period: 30s

  plextracnginx:
    image: "plextrac/plextracnginx:${UPGRADE_STRATEGY:-stable}"
    environment:
      CLIENT_DOMAIN_NAME: "${CLIENT_DOMAIN_NAME:?err}"
      LETS_ENCRYPT_EMAIL: "${LETS_ENCRYPT_EMAIL:-}"
      USE_CUSTOM_CERT: "${USE_CUSTOM_CERT-}"
      HIDE_COPYRIGHT: "${HIDE_COPYRIGHT-}"
      HIDE_PAGE_TITLE: "${HIDE_PAGE_TITLE-}"
      OVERRIDE_SENTRY_FRONTEND_ENABLED: "${OVERRIDE_SENTRY_FRONTEND_ENABLED-}"
    ports:
    - 0.0.0.0:80:80/tcp
    - 0.0.0.0:443:443/tcp
    restart: always
    volumes:
    - letsencrypt:/etc/letsencrypt:rw

  redis:
    image: redis:6.2-alpine
    command: "redis-server --requirepass ${REDIS_PASSWORD}"
    container_name: redis
    volumes:
    - redis:/etc/redis:rw
    restart: always

volumes:
  dbdata: {}
  uploads: {}
  letsencrypt: {}
  redis:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${PLEXTRAC_HOME:-.}/volumes/redis'
  couchbase-backups:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${PLEXTRAC_HOME:-.}/backups/couchbase'

networks:
  default:
    name: plextrac
    driver: bridge
